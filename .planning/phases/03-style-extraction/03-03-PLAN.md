---
phase: 03-style-extraction
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - src/components/chat/style-extraction-card.tsx
  - src/components/chat/message-item.tsx
  - src/components/brand/moodboard.tsx
  - src/app/(chat)/[brandId]/page.tsx
autonomous: false

must_haves:
  truths:
    - "User sees extracted colors as visual swatches"
    - "User sees mood keywords as tags/chips"
    - "User sees confidence score for extraction"
    - "User can view brand moodboard showing references and style"
  artifacts:
    - path: "src/components/chat/style-extraction-card.tsx"
      provides: "Visual display of extracted style"
      contains: "StyleExtractionCard"
    - path: "src/components/brand/moodboard.tsx"
      provides: "Brand moodboard view"
      contains: "Moodboard"
  key_links:
    - from: "src/components/chat/message-item.tsx"
      to: "src/components/chat/style-extraction-card.tsx"
      via: "renders StyleExtractionCard for extraction messages"
      pattern: "StyleExtractionCard"
    - from: "src/app/(chat)/[brandId]/page.tsx"
      to: "src/components/brand/moodboard.tsx"
      via: "renders Moodboard component"
      pattern: "Moodboard"
---

<objective>
Display extraction feedback and brand moodboard

Purpose: Complete the style extraction user experience by showing visual feedback on what was extracted (colors, mood, keywords) and providing a moodboard view where users can see their brand's references and characteristics together.

Output:
- StyleExtractionCard component showing colors, mood, keywords, confidence
- Updated MessageItem to detect and render extraction cards
- Moodboard component for brand definition view
- Integration into brand page with moodboard tab/section
</objective>

<execution_context>
@C:\Users\gerar\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\gerar\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-style-extraction/03-RESEARCH.md
@.planning/phases/03-style-extraction/03-01-SUMMARY.md
@.planning/phases/03-style-extraction/03-02-SUMMARY.md

@src/components/chat/message-item.tsx
@src/types/brand.ts
@src/lib/db/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create StyleExtractionCard component</name>
  <files>
    src/components/chat/style-extraction-card.tsx
    src/components/chat/message-item.tsx
  </files>
  <action>
1. Create src/components/chat/style-extraction-card.tsx:

```tsx
'use client';

import type { ExtractedStyleData } from '@/types/brand';

interface StyleExtractionCardProps {
  style: ExtractedStyleData;
  isExtracting?: boolean;
}

export function StyleExtractionCard({ style, isExtracting }: StyleExtractionCardProps) {
  if (isExtracting) {
    return (
      <div className="rounded-xl border border-gray-200 bg-white p-4 animate-pulse">
        <div className="flex items-center gap-2">
          <div className="w-4 h-4 rounded-full bg-gray-200" />
          <span className="text-sm text-gray-500">Extracting style from your references...</span>
        </div>
      </div>
    );
  }

  return (
    <div className="rounded-xl border border-gray-200 bg-white p-4 space-y-4 max-w-md">
      <div className="flex items-center justify-between">
        <h3 className="font-medium text-gray-900">Extracted Style</h3>
        <span className="text-xs text-gray-500">
          {Math.round(style.confidence * 100)}% confidence
        </span>
      </div>

      {/* Color Palette */}
      <div>
        <p className="text-xs text-gray-500 mb-2 uppercase tracking-wide">Colors</p>
        <div className="flex gap-3">
          {Object.entries(style.colors).map(([name, hex]) => (
            <div key={name} className="text-center">
              <div
                className="w-12 h-12 rounded-lg border border-gray-200 shadow-sm"
                style={{ backgroundColor: hex }}
                title={hex}
              />
              <span className="text-xs text-gray-500 mt-1 block capitalize">{name}</span>
            </div>
          ))}
        </div>
      </div>

      {/* Mood & Keywords */}
      <div>
        <p className="text-xs text-gray-500 mb-2 uppercase tracking-wide">Mood</p>
        <div className="flex flex-wrap gap-2">
          <span className="px-3 py-1 bg-gray-900 text-white text-sm rounded-full">
            {style.mood.primary}
          </span>
          {style.mood.keywords.map((kw) => (
            <span key={kw} className="px-3 py-1 bg-gray-100 text-gray-700 text-sm rounded-full">
              {kw}
            </span>
          ))}
        </div>
      </div>

      {/* Typography */}
      <div>
        <p className="text-xs text-gray-500 mb-2 uppercase tracking-wide">Typography</p>
        <div className="flex gap-4 text-sm">
          <div>
            <span className="text-gray-500">Style:</span>{' '}
            <span className="text-gray-900">{style.typography.style}</span>
          </div>
          <div>
            <span className="text-gray-500">Weight:</span>{' '}
            <span className="text-gray-900">{style.typography.weight}</span>
          </div>
          <div>
            <span className="text-gray-500">Feel:</span>{' '}
            <span className="text-gray-900">{style.typography.mood}</span>
          </div>
        </div>
      </div>

      {/* Visual Style */}
      <div>
        <p className="text-xs text-gray-500 mb-2 uppercase tracking-wide">Visual Characteristics</p>
        <div className="grid grid-cols-3 gap-2 text-sm">
          <div className="text-center p-2 bg-gray-50 rounded-lg">
            <div className="text-gray-900 font-medium capitalize">{style.visualStyle.complexity}</div>
            <div className="text-xs text-gray-500">Complexity</div>
          </div>
          <div className="text-center p-2 bg-gray-50 rounded-lg">
            <div className="text-gray-900 font-medium capitalize">{style.visualStyle.contrast}</div>
            <div className="text-xs text-gray-500">Contrast</div>
          </div>
          <div className="text-center p-2 bg-gray-50 rounded-lg">
            <div className="text-gray-900 font-medium capitalize">{style.visualStyle.texture}</div>
            <div className="text-xs text-gray-500">Texture</div>
          </div>
        </div>
      </div>

      {/* Tone indicator */}
      <div className="flex items-center gap-2 pt-2 border-t border-gray-100">
        <div className={`w-3 h-3 rounded-full ${
          style.mood.tone === 'warm' ? 'bg-orange-400' :
          style.mood.tone === 'cool' ? 'bg-blue-400' : 'bg-gray-400'
        }`} />
        <span className="text-sm text-gray-600 capitalize">{style.mood.tone} tone</span>
      </div>
    </div>
  );
}
```

2. Update src/components/chat/message-item.tsx to render StyleExtractionCard:

a) Import the component:
```typescript
import { StyleExtractionCard } from './style-extraction-card';
import type { ExtractedStyleData } from '@/types/brand';
```

b) Add detection for style extraction in message content. Look for JSON block with style data:
```typescript
function extractStyleFromMessage(content: string): ExtractedStyleData | null {
  // Look for [EXTRACTED_STYLE] marker or JSON block
  const jsonMatch = content.match(/```json\n([\s\S]*?)\n```/);
  if (jsonMatch) {
    try {
      const parsed = JSON.parse(jsonMatch[1]);
      if (parsed.colors && parsed.mood && parsed.typography) {
        return parsed as ExtractedStyleData;
      }
    } catch {
      return null;
    }
  }
  return null;
}
```

c) In the render, after ReactMarkdown, check for and render extraction card:
```tsx
{/* Check for style extraction data */}
{(() => {
  const extractedStyle = message.role === 'assistant'
    ? extractStyleFromMessage(textContent)
    : null;
  return extractedStyle ? (
    <StyleExtractionCard style={extractedStyle} />
  ) : null;
})()}
```

Note: The chat API will include the style data in a JSON code block within the response when extraction occurs.
  </action>
  <verify>
    - `npm run build` passes
    - StyleExtractionCard component exists and renders without errors
    - MessageItem detects style extraction JSON and renders card
  </verify>
  <done>
    StyleExtractionCard displays extracted colors, mood, typography, visual style with confidence. MessageItem detects and renders extraction cards in assistant messages.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Moodboard component and integrate into brand page</name>
  <files>
    src/components/brand/moodboard.tsx
    src/app/(chat)/[brandId]/page.tsx
  </files>
  <action>
1. Create src/components/brand/moodboard.tsx:

```tsx
'use client';

import Image from 'next/image';
import type { BrandStyle, ExtractedStyleData } from '@/types/brand';
import { StyleExtractionCard } from '@/components/chat/style-extraction-card';

interface MoodboardProps {
  brandName: string;
  style: BrandStyle;
}

export function Moodboard({ brandName, style }: MoodboardProps) {
  const { referenceImages, extractedStyle } = style;
  const hasReferences = referenceImages && referenceImages.length > 0;
  const hasStyle = !!extractedStyle;

  if (!hasReferences && !hasStyle) {
    return (
      <div className="flex flex-col items-center justify-center h-64 text-gray-500">
        <div className="text-lg mb-2">No style defined yet</div>
        <p className="text-sm">Upload reference images in the chat to extract your brand style.</p>
      </div>
    );
  }

  return (
    <div className="space-y-6 p-6">
      <div>
        <h2 className="text-xl font-semibold text-gray-900 mb-1">{brandName}</h2>
        <p className="text-sm text-gray-500">Brand Style Definition</p>
      </div>

      {/* Reference Images Grid */}
      {hasReferences && (
        <div>
          <h3 className="text-sm font-medium text-gray-700 mb-3 uppercase tracking-wide">
            Reference Images
          </h3>
          <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
            {referenceImages.map((url, i) => (
              <div key={i} className="relative aspect-square rounded-lg overflow-hidden border border-gray-200 shadow-sm">
                <Image
                  src={url}
                  alt={`Reference ${i + 1}`}
                  fill
                  className="object-cover"
                />
              </div>
            ))}
          </div>
        </div>
      )}

      {/* Extracted Style Card */}
      {hasStyle && extractedStyle && (
        <div>
          <h3 className="text-sm font-medium text-gray-700 mb-3 uppercase tracking-wide">
            Extracted Style
          </h3>
          <StyleExtractionCard style={extractedStyle} />
        </div>
      )}

      {/* Quick Reference Section */}
      {hasStyle && extractedStyle && (
        <div className="border-t border-gray-200 pt-6">
          <h3 className="text-sm font-medium text-gray-700 mb-3 uppercase tracking-wide">
            Quick Reference
          </h3>
          <div className="grid grid-cols-2 gap-4 text-sm">
            <div>
              <span className="text-gray-500">Primary Color:</span>{' '}
              <span className="font-mono">{extractedStyle.colors.primary}</span>
            </div>
            <div>
              <span className="text-gray-500">Secondary Color:</span>{' '}
              <span className="font-mono">{extractedStyle.colors.secondary}</span>
            </div>
            <div>
              <span className="text-gray-500">Mood:</span>{' '}
              <span>{extractedStyle.mood.primary}</span>
            </div>
            <div>
              <span className="text-gray-500">Typography:</span>{' '}
              <span>{extractedStyle.typography.style}</span>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
```

2. Update src/app/(chat)/[brandId]/page.tsx to include moodboard section:

a) Import Moodboard:
```typescript
import { Moodboard } from '@/components/brand/moodboard';
```

b) Fetch brand data with style (may already exist from Phase 2, extend if needed):
```typescript
// Add to existing brand fetch or create new
const brand = /* existing brand state or fetch */;
```

c) Add a tab or collapsible section for moodboard view. Simple approach - add below chat or as a toggle:
```tsx
{/* Moodboard Section - show when brand has style */}
{brand?.style?.extractedStyle && (
  <div className="border-t border-gray-200">
    <Moodboard brandName={brand.name} style={brand.style} />
  </div>
)}
```

Alternative: Add a "View Moodboard" button that opens a slide-over or modal.

For simplicity in this phase, integrate as a collapsible section below the chat when style exists.
  </action>
  <verify>
    - `npm run build` passes
    - Moodboard component renders reference images and style card
    - Brand page shows moodboard section when style exists
  </verify>
  <done>
    Moodboard component displays references and extracted style. Brand page integrates moodboard view.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete style extraction flow:
    1. Image upload in chat (from 03-01)
    2. AI style extraction with structured JSON (from 03-02)
    3. Style persistence to brand database (from 03-02)
    4. Visual feedback with StyleExtractionCard
    5. Brand moodboard showing references + extracted style
  </what-built>
  <how-to-verify>
    1. Start dev server: `npm run dev`
    2. Navigate to http://localhost:3000
    3. Create or select a brand
    4. Click the Paperclip icon and select 1-3 reference images
    5. Send message (with or without text)
    6. Verify: Images appear as previews before sending
    7. Verify: AI responds with style extraction feedback
    8. Verify: StyleExtractionCard shows colors, mood, keywords
    9. Verify: Moodboard section appears with references and style
    10. Refresh page - verify style persists (saved to brand)
    11. Check database or API response to confirm style was stored
  </how-to-verify>
  <resume-signal>Type "approved" if extraction flow works end-to-end, or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. Component check:
   - StyleExtractionCard renders colors, mood, typography, confidence
   - Moodboard renders reference images and style card
   - MessageItem detects and displays extraction cards

2. Integration check:
   - Brand page shows moodboard when style exists
   - Style card appears in chat after extraction
   - End-to-end flow: upload -> extract -> persist -> display

3. Build check:
   - `npm run build` passes
   - No TypeScript errors
</verification>

<success_criteria>
- StyleExtractionCard displays colors as visual swatches
- StyleExtractionCard displays mood keywords as tags
- StyleExtractionCard shows confidence percentage
- MessageItem detects extraction JSON and renders card
- Moodboard component shows reference images in grid
- Moodboard component shows extracted style card
- Brand page integrates moodboard view
- User can verify full extraction flow works end-to-end (including persistence)
</success_criteria>

<output>
After completion, create `.planning/phases/03-style-extraction/03-03-SUMMARY.md`
</output>
