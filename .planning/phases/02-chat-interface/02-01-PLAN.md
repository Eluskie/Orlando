---
phase: 02-chat-interface
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(chat)/layout.tsx
  - src/app/(chat)/page.tsx
  - src/app/(chat)/[brandId]/page.tsx
  - src/components/chat/chat-sidebar.tsx
  - src/app/api/chat/route.ts
  - src/lib/ai/chat.ts
autonomous: true

must_haves:
  truths:
    - "User sees app shell with persistent left sidebar"
    - "Sidebar shows brand list (empty initially)"
    - "Chat API returns streaming response"
  artifacts:
    - path: "src/app/(chat)/layout.tsx"
      provides: "App shell with sidebar + main area"
      min_lines: 30
    - path: "src/components/chat/chat-sidebar.tsx"
      provides: "Brand list sidebar component"
      min_lines: 40
    - path: "src/app/api/chat/route.ts"
      provides: "Streaming chat endpoint"
      exports: ["POST"]
  key_links:
    - from: "src/app/(chat)/layout.tsx"
      to: "src/components/chat/chat-sidebar.tsx"
      via: "import and render"
      pattern: "ChatSidebar"
    - from: "src/app/api/chat/route.ts"
      to: "src/lib/ai/config.ts"
      via: "mock mode check"
      pattern: "isMockMode"
---

<objective>
Create the app shell layout with OpenCode-inspired sidebar and streaming chat API endpoint

Purpose: Establish the visual and backend foundation for the chat interface. The sidebar provides brand navigation while the API route enables real-time streaming responses.

Output:
- Route group `(chat)` with three-panel layout shell
- ChatSidebar component showing brand list with "New Brand" button
- POST /api/chat endpoint with Vercel AI SDK streaming (mock mode supported)
</objective>

<execution_context>
@C:\Users\gerar\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\gerar\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-chat-interface/02-CONTEXT.md
@.planning/phases/02-chat-interface/02-RESEARCH.md
@.planning/phases/01-foundation/01-02-SUMMARY.md

# Existing code to reference
@src/stores/brand-store.ts
@src/lib/ai/config.ts
@src/lib/ai/mock.ts
@src/lib/db/schema.ts
@src/app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create chat route group layout with sidebar</name>
  <files>
    src/app/(chat)/layout.tsx
    src/app/(chat)/page.tsx
    src/app/(chat)/[brandId]/page.tsx
    src/components/chat/chat-sidebar.tsx
  </files>
  <action>
Create the app shell following OpenCode-inspired layout from CONTEXT.md decisions:

1. Create `src/app/(chat)/layout.tsx`:
   - Three-panel flexbox layout (sidebar 256px + main flex-1)
   - Import and render ChatSidebar component
   - Main area receives children
   - Use design system classes from globals.css

2. Create `src/app/(chat)/page.tsx`:
   - Default page when no brand selected
   - Centered welcome message: "Start by creating a brand or selecting one from the sidebar"
   - Use max-w-2xl mx-auto for centered column (like Claude.ai)

3. Create `src/app/(chat)/[brandId]/page.tsx`:
   - Dynamic route for brand-specific chat
   - For now, just display placeholder: "Chat for {brandId}"
   - This will be connected to useChat in Plan 02

4. Create `src/components/chat/chat-sidebar.tsx`:
   - 'use client' directive (needs useBrandStore)
   - Fixed width sidebar with border-r
   - Header with "Dobra" title
   - Brand list from useBrandStore (map over brands array)
   - Each brand item: clickable, shows name, active state styling
   - "New Brand" button at bottom (plus icon from lucide-react)
   - Empty state: just show the New Brand button when no brands
   - On brand click: use Next.js router to navigate to /[brandId]
   - On New Brand click: navigate to / (root chat starts brand creation)

Use Tailwind classes matching the design system (bg-gray-50 for sidebar, hover states, etc.)
  </action>
  <verify>
Run `npm run dev`, navigate to http://localhost:3000.
- See sidebar on left with "Dobra" header and "New Brand" button
- Main area shows welcome message
- No console errors
  </verify>
  <done>
App shell renders with persistent sidebar. Clicking "New Brand" navigates to root. Brand list is empty but ready to show brands.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create streaming chat API endpoint</name>
  <files>
    src/app/api/chat/route.ts
    src/lib/ai/chat.ts
  </files>
  <action>
Create the chat API route following RESEARCH.md patterns:

1. Create `src/lib/ai/chat.ts`:
   - Export system prompt constant for brand creation assistant
   - System prompt should: introduce Dobra, guide users to create brands, be helpful and concise
   - Export helper to format messages for model (use convertToModelMessages from 'ai')

2. Create `src/app/api/chat/route.ts`:
   - POST handler accepting { messages, brandId?, conversationId? } in body
   - Check isMockMode() from src/lib/ai/config.ts
   - If mock mode:
     * Use mockChat() from src/lib/ai/mock.ts
     * Return mock response with simulated streaming (TextEncoder + ReadableStream)
     * Add small delays between chunks to simulate streaming
   - If real mode:
     * Use streamText from 'ai' package
     * Use google('gemini-1.5-pro') model from @ai-sdk/google
     * Import system prompt from chat.ts
     * Return result.toUIMessageStreamResponse()
   - Do NOT add persistence yet (that's Plan 03)
   - Handle errors gracefully, return 500 with error message

Note: The mock streaming should chunk the response word-by-word with ~50ms delays to feel natural.
  </action>
  <verify>
Test with curl:
```
curl -X POST http://localhost:3000/api/chat \
  -H "Content-Type: application/json" \
  -d '{"messages":[{"role":"user","parts":[{"type":"text","text":"Hello"}]}]}'
```
Should receive streaming response (chunks arrive over time in mock mode).
  </verify>
  <done>
POST /api/chat returns streaming response. Mock mode chunks response with delays. Real mode uses Gemini (when MOCK_AI_MODE=false and GOOGLE_GENERATIVE_AI_API_KEY set).
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npm run build` passes without errors
2. App shell renders at localhost:3000 with sidebar
3. /api/chat endpoint streams responses
4. TypeScript compilation clean (`npx tsc --noEmit`)
</verification>

<success_criteria>
- Layout shell with sidebar visible at all routes under (chat)
- ChatSidebar component renders brand list and New Brand button
- API route handles both mock and real AI modes
- Streaming works (response arrives in chunks, not all at once)
</success_criteria>

<output>
After completion, create `.planning/phases/02-chat-interface/02-01-SUMMARY.md`
</output>
