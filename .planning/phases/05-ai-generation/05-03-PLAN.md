---
phase: 05-ai-generation
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/app/api/generations/[brandId]/route.ts
  - src/components/canvas/generation-history.tsx
  - src/components/canvas/canvas-workspace.tsx
  - src/lib/ai/chat.ts
autonomous: true

must_haves:
  truths:
    - "User can view a list of past generations for the current brand"
    - "Each history entry shows prompt, timestamp, and thumbnail of generated images"
    - "User can click a history entry to add its images back to the canvas"
    - "User can trigger generation from chat by saying 'generate an image of...'"
    - "Chat-triggered generation calls the same /api/generate endpoint"
  artifacts:
    - path: "src/app/api/generations/[brandId]/route.ts"
      provides: "GET endpoint returning generation history with assets"
      exports: ["GET"]
    - path: "src/components/canvas/generation-history.tsx"
      provides: "Slide-out panel showing generation history per brand"
      exports: ["GenerationHistory"]
  key_links:
    - from: "src/app/api/generations/[brandId]/route.ts"
      to: "src/lib/db/queries/generations.ts"
      via: "getGenerationHistory import"
      pattern: "getGenerationHistory"
    - from: "src/components/canvas/generation-history.tsx"
      to: "/api/generations/[brandId]"
      via: "fetch GET call"
      pattern: "fetch.*api/generations"
    - from: "src/components/canvas/generation-history.tsx"
      to: "src/stores/canvas-store.ts"
      via: "addNode to place history images on canvas"
      pattern: "addNode"
    - from: "src/lib/ai/chat.ts"
      to: "/api/generate"
      via: "tool call for generation"
      pattern: "generate|api/generate"
---

<objective>
Build generation history display and chat-based generation trigger. Users can view past generations per brand in a slide-out panel, click to reuse them on canvas, and trigger generation from chat with natural language ("generate an image of a mountain").

Purpose: This completes HIST-01, HIST-02 (history viewing/reuse) and GEN-07 (generate via chat OR toolbar). History lets users build a library of generated assets per brand. Chat generation provides a conversational alternative to the toolbar.

Output: Generation history API + panel component, chat generation detection integrated into existing chat flow.
</objective>

<execution_context>
@C:\Users\gerar\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\gerar\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-ai-generation/05-RESEARCH.md
@.planning/phases/05-ai-generation/05-01-SUMMARY.md

@src/lib/db/queries/generations.ts
@src/lib/db/schema.ts
@src/lib/ai/chat.ts
@src/app/api/chat/route.ts
@src/stores/canvas-store.ts
@src/stores/brand-store.ts
@src/components/canvas/canvas-workspace.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create generation history API and panel component</name>
  <files>
    src/app/api/generations/[brandId]/route.ts
    src/components/canvas/generation-history.tsx
  </files>
  <action>
1. Create `src/app/api/generations/[brandId]/route.ts`:
   - Import NextResponse from next/server
   - Import getGenerationHistory from @/lib/db/queries/generations
   - GET handler with params: Promise<{ brandId: string }>
   - Await params, call getGenerationHistory(brandId, 50)
   - Return NextResponse.json(generations)
   - Wrap in try/catch, return 500 on error

2. Create `src/components/canvas/generation-history.tsx`:
   - 'use client' directive
   - Import: useState, useEffect from react; History, X, Plus, Clock from lucide-react; useCanvasStore/CanvasNode/ImageNodeData from canvas-store; useBrandStore from brand-store
   - Export `GenerationHistory` component
   - State: isOpen (boolean), generations (array), loading (boolean)
   - Get activeBrandId from useBrandStore
   - Get addNode from useCanvasStore
   - Define Generation type inline: { id: string, prompt: string, status: string, createdAt: string, assets: Array<{ id: string, url: string, name: string, width?: number, height?: number }> }
   - useEffect: when isOpen && activeBrandId, fetch GET /api/generations/${activeBrandId}, set generations from response
   - Render:
     - Toggle button: absolute top-4 right-52 z-10 (positioned left of the GenerationToolbar), button with History icon, bg-white rounded-lg shadow-md border p-2 hover:bg-gray-50
     - When isOpen: a slide-out panel on the right side:
       - Fixed position, right-0 top-0 h-full w-80 bg-white shadow-xl border-l z-20
       - Header: "Generation History" + X close button
       - Scrollable list of generations (overflow-y-auto flex-1):
         - Each generation shows:
           - Prompt text (truncated to 60 chars)
           - Timestamp (relative: "2 hours ago" style using simple calculation with Date.now() - new Date(createdAt).getTime())
           - Grid of asset thumbnails (2 columns, each 80x80 with object-cover rounded)
           - "Add to Canvas" button with Plus icon for each generation
       - Empty state: "No generations yet" with muted text
   - On "Add to Canvas" click for a generation:
     - For each asset in generation.assets:
       - Create a CanvasNode with type 'image', position { x: 100 + i * 220, y: 300 }, data: { src: asset.url, width: asset.width || 200, height: asset.height || 200, opacity: 1, locked: false, label: asset.name }
       - Call addNode(node)
     - Close the panel
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - API route responds to GET /api/generations/{brandId} with array of generation records
    - Component renders history panel with generation entries
  </verify>
  <done>
    - GET /api/generations/[brandId] returns generation history with nested assets
    - History panel shows list of past generations with prompt, time, and thumbnails
    - Clicking "Add to Canvas" creates image nodes from historical generation assets
    - Empty state displays when no generations exist
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire chat-based generation and integrate history panel</name>
  <files>
    src/lib/ai/chat.ts
    src/components/canvas/canvas-workspace.tsx
    src/components/canvas/index.ts
  </files>
  <action>
1. Create or update `src/lib/ai/chat.ts` to add generation detection:
   - If chat.ts doesn't have generation-related logic, add it:
   - Export `detectGenerationIntent(message: string): { isGeneration: boolean; prompt: string | null }`
   - Check message against patterns: /generate\s+(?:an?\s+)?(?:image|illustration|graphic|picture)/i, /create\s+(?:an?\s+)?(?:image|illustration|graphic|picture)/i, /draw\s+(?:an?\s+)?(?:image|illustration|graphic|picture)/i, /make\s+(?:an?\s+)?(?:image|illustration|graphic|picture)/i
   - If match found: extract the rest of the message after the pattern as the prompt (remove the trigger phrase, strip leading "of " if present)
   - Return { isGeneration: true, prompt } or { isGeneration: false, prompt: null }
   - Also export `triggerGenerationFromChat(prompt: string, brandId: string): Promise<{ generationId: string; assets: Array<{ id: string; url: string; name: string }> }>`
   - This function calls fetch POST /api/generate with { prompt, brandId, count: 4 } and returns the parsed response
   - NOTE: This function will be called from client-side components, so it should work in browser context (use relative URL /api/generate)

2. Update `src/components/canvas/canvas-workspace.tsx`:
   - Import GenerationHistory from './generation-history'
   - Add GenerationHistory to the render, alongside CanvasToolbar and GenerationToolbar:
     ```
     <CanvasToolbar />
     <GenerationToolbar />
     <GenerationHistory />
     ```
   - Keep everything else unchanged

3. Update `src/components/canvas/index.ts`:
   - Add exports: `export { GenerationHistory } from './generation-history'`
   - Add exports: `export { GenerationToolbar } from './generation-toolbar'`
   - Keep existing exports
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run dev` starts without errors
    - Canvas page shows both Generate button and History button
    - detectGenerationIntent("generate an image of a sunset") returns { isGeneration: true, prompt: "a sunset" }
    - detectGenerationIntent("hello world") returns { isGeneration: false, prompt: null }
  </verify>
  <done>
    - Chat generation detection correctly identifies "generate/create/draw an image of..." patterns
    - triggerGenerationFromChat function calls /api/generate and returns results
    - Generation history panel accessible from canvas via History button
    - Canvas workspace renders all three toolbar components (toolbar, generate, history)
    - All canvas components exported from index.ts
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Dev server runs: `npm run dev`
3. History button visible on canvas, opens slide-out panel
4. History panel loads and displays past generations (empty state if none)
5. "Add to Canvas" places historical images as nodes on canvas
6. detectGenerationIntent correctly parses generation commands
7. Generation history API returns correct data shape
</verification>

<success_criteria>
- User can view generation history for current brand in a slide-out panel
- History entries show prompt, relative timestamp, and asset thumbnails
- User can click to add historical generation images back to canvas
- Chat detection identifies generation intent from natural language
- triggerGenerationFromChat provides programmatic generation access for chat integration
- All components properly integrated into canvas workspace
</success_criteria>

<output>
After completion, create `.planning/phases/05-ai-generation/05-03-SUMMARY.md`
</output>
