---
phase: 05-ai-generation
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/components/canvas/placeholder-node.tsx
  - src/components/canvas/generation-toolbar.tsx
  - src/components/canvas/canvas-workspace.tsx
  - src/components/canvas/index.ts
  - src/stores/generation-store.ts
autonomous: true

must_haves:
  truths:
    - "User clicks Generate button on canvas toolbar and enters a prompt"
    - "User can optionally attach an image/sketch for image-to-image generation (GEN-02)"
    - "Placeholder nodes appear on canvas immediately while generation is in progress"
    - "Placeholders are replaced with real image nodes when generation completes"
    - "User sees loading spinner and prompt text on placeholder during generation"
    - "Multiple variations (2-4) appear as separate nodes on canvas"
  artifacts:
    - path: "src/components/canvas/placeholder-node.tsx"
      provides: "ReactFlow custom node showing loading state during generation"
      exports: ["PlaceholderNode"]
    - path: "src/components/canvas/generation-toolbar.tsx"
      provides: "Generate button with prompt input popover and optional image upload"
      exports: ["GenerationToolbar"]
    - path: "src/stores/generation-store.ts"
      provides: "Extended store with placeholder tracking for optimistic UI"
  key_links:
    - from: "src/components/canvas/generation-toolbar.tsx"
      to: "/api/generate"
      via: "fetch POST call with optional image field"
      pattern: "fetch.*api/generate"
    - from: "src/components/canvas/generation-toolbar.tsx"
      to: "src/stores/canvas-store.ts"
      via: "addNode for placeholders and real image nodes"
      pattern: "addNode|removeNode"
    - from: "src/components/canvas/canvas-workspace.tsx"
      to: "src/components/canvas/placeholder-node.tsx"
      via: "nodeTypes registration"
      pattern: "placeholder.*PlaceholderNode"
---

<objective>
Build the canvas generation UI: a PlaceholderNode for optimistic loading states, a GenerationToolbar with prompt input and optional image upload (for sketch/image-to-image per GEN-02), and wire the complete flow - user enters prompt (optionally attaches image), placeholder nodes appear instantly on canvas, API call fires, placeholders are replaced with real image nodes on completion.

Purpose: This is the core UX for generation (GEN-02, GEN-05, GEN-07). Users need immediate visual feedback when generating, not a blank wait. The optimistic UI pattern with placeholder nodes makes generation feel instant and keeps users engaged during the 2-30 second generation time. The optional image upload enables sketch-to-image workflows.

Output: Working generate-from-canvas flow with placeholder -> real image transition, optional image input, integrated into the existing canvas workspace.
</objective>

<execution_context>
@C:\Users\gerar\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\gerar\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-ai-generation/05-RESEARCH.md
@.planning/phases/05-ai-generation/05-01-SUMMARY.md

@src/components/canvas/canvas-workspace.tsx
@src/components/canvas/canvas-toolbar.tsx
@src/components/canvas/image-node.tsx
@src/components/canvas/index.ts
@src/stores/canvas-store.ts
@src/stores/generation-store.ts
@src/app/(chat)/[brandId]/canvas/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PlaceholderNode and extend generation store</name>
  <files>
    src/components/canvas/placeholder-node.tsx
    src/stores/generation-store.ts
    src/components/canvas/index.ts
  </files>
  <action>
1. Create `src/components/canvas/placeholder-node.tsx`:
   - 'use client' directive
   - Import memo from react, NodeProps from @xyflow/react, Loader2 from lucide-react
   - Define PlaceholderNodeData interface extending Record<string, unknown>:
     - prompt: string
     - status: 'pending' | 'generating' | 'complete' | 'error'
     - errorMessage?: string
   - Export `PlaceholderNode = memo(function PlaceholderNode({ data }: NodeProps)` (cast data to PlaceholderNodeData)
   - Render a 200x200 div with:
     - bg-white rounded-lg border-2 border-dashed border-indigo-300 (match the project's indigo accent)
     - flex flex-col items-center justify-center p-4
     - When status is 'pending' or 'generating': show Loader2 with animate-spin (w-8 h-8 text-indigo-400), text below showing status ('Queued...' or 'Generating...')
     - When status is 'error': show red X icon and errorMessage
     - Always show truncated prompt text at bottom (text-xs text-gray-400, max 40 chars + '...')
   - No Handle components needed (these aren't connectable nodes)

2. Extend `src/stores/generation-store.ts`:
   - Add to GenerationState interface:
     - `placeholders: Record<string, { prompt: string; brandId: string; status: 'pending' | 'generating' | 'complete' | 'error' }>`
     - `addPlaceholder: (id: string, data: { prompt: string; brandId: string }) => void`
     - `updatePlaceholderStatus: (id: string, status: 'pending' | 'generating' | 'complete' | 'error') => void`
     - `removePlaceholder: (id: string) => void`
   - Initialize `placeholders: {}` in default state
   - Implement addPlaceholder: sets placeholders[id] with status: 'pending'
   - Implement updatePlaceholderStatus: updates the specific placeholder's status
   - Implement removePlaceholder: deletes the placeholder entry using object rest/spread
   - Keep all existing fields and methods unchanged

3. Update `src/components/canvas/index.ts`:
   - Add export for PlaceholderNode: `export { PlaceholderNode } from './placeholder-node'`
   - Keep existing exports
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - PlaceholderNode component renders without errors (check import resolution)
    - generation-store.ts has placeholders state and all 3 new actions
  </verify>
  <done>
    - PlaceholderNode shows loading spinner, status text, and truncated prompt
    - Generation store tracks placeholder lifecycle (add -> update status -> remove)
    - Canvas index exports PlaceholderNode
  </done>
</task>

<task type="auto">
  <name>Task 2: Add GenerationToolbar with image upload and wire optimistic generation flow</name>
  <files>
    src/components/canvas/generation-toolbar.tsx
    src/components/canvas/canvas-workspace.tsx
  </files>
  <action>
1. Create `src/components/canvas/generation-toolbar.tsx`:
   - 'use client' directive
   - Import: useState, useRef from react, Sparkles/X/ImagePlus/Trash2 from lucide-react, useCanvasStore from canvas-store, useGenerationStore from generation-store, useBrandStore from brand-store
   - Export `GenerationToolbar` component
   - State: isOpen (boolean, default false), prompt (string), count (number, default 4), isGenerating (boolean), imageFile (File | null), imagePreview (string | null)
   - Get activeBrandId from useBrandStore, activeBrand from useBrandStore((s) => s.activeBrand())
   - Get addNode/removeNode from useCanvasStore
   - Get addPlaceholder/updatePlaceholderStatus/removePlaceholder/incrementDailyCount/canGenerate from useGenerationStore
   - Create a hidden file input ref: `const fileInputRef = useRef<HTMLInputElement>(null)`
   - Render a floating panel positioned absolute top-4 right-4 z-10:
     - When collapsed (!isOpen): just a button with Sparkles icon + "Generate" text, bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 px-4 py-2
     - When expanded (isOpen): a white rounded-lg shadow-lg border p-4 w-80 panel:
       - Header: "Generate Images" + X close button
       - Textarea for prompt (3 rows, placeholder: "Describe what you want to generate...")
       - **Image upload section (GEN-02 sketch/image-to-image):**
         - Hidden `<input type="file" accept="image/*" ref={fileInputRef}>` that onChange reads the file, creates a preview URL via URL.createObjectURL, and stores the File object
         - If no imageFile: show a dashed border button with ImagePlus icon + "Attach image/sketch (optional)" text. Clicking triggers fileInputRef.current?.click()
         - If imageFile: show a small thumbnail (h-16 w-16 object-cover rounded) of imagePreview, the file name truncated, and a Trash2 icon button to clear the image (set imageFile=null, imagePreview=null, revoke the object URL)
       - Count selector: row of 4 buttons (1-4) to pick variation count, highlight selected with bg-indigo-100
       - Generate button: full width, bg-indigo-600, disabled when !prompt || isGenerating || !canGenerate() || !activeBrandId
       - If !canGenerate(): show "Daily limit reached" in red text
   - On generate click, run the full optimistic flow:
     a. Set isGenerating = true
     b. Convert imageFile to base64 if present: read via FileReader.readAsDataURL, strip the data URL prefix to get raw base64 string
     c. Create placeholder IDs: `placeholder-${Date.now()}-${i}` for each count
     d. For each placeholder: call addPlaceholder(id, { prompt, brandId: activeBrandId })
     e. For each placeholder: call addNode to canvas with type: 'placeholder', position distributed horizontally (x: 100 + i * 220, y: 100), data: { prompt, status: 'generating' }
     f. Call fetch POST /api/generate with { prompt, brandId: activeBrandId, count, image: base64OrUndefined }
     g. On success response (response.json()):
        - For each asset in response.assets:
          - Remove corresponding placeholder node from canvas (removeNode)
          - Remove placeholder from generation store (removePlaceholder)
          - Add new image node to canvas: type 'image', same position area (x: 100 + i * 220, y: 100), data: { src: asset.url, width: 200, height: 200, opacity: 1, locked: false, label: asset.name }
        - Call incrementDailyCount()
     h. On error: update placeholder statuses to 'error', show console.error
     i. Set isGenerating = false, clear prompt, clear imageFile/imagePreview, close panel
   - Note: import type CanvasNode and ImageNodeData from canvas-store for typing the nodes

2. Update `src/components/canvas/canvas-workspace.tsx`:
   - Import PlaceholderNode from './placeholder-node'
   - Import GenerationToolbar from './generation-toolbar'
   - Add 'placeholder' to nodeTypes: `const nodeTypes = { image: ImageNode, placeholder: PlaceholderNode } as const`
   - Replace the existing `<CanvasToolbar />` with a fragment containing both: `<CanvasToolbar />` and `<GenerationToolbar />`
   - Keep everything else unchanged
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run dev` starts without errors
    - Navigate to a brand's canvas page: the Generate button appears in top-right
    - Click Generate button: panel opens with prompt input, image upload area, and count selector
    - Verify image upload: click "Attach image/sketch", select a file, see thumbnail preview, click trash to remove
    - Enter a prompt and click Generate (with MOCK_AI_MODE=true): placeholders appear on canvas, then get replaced with generated images
  </verify>
  <done>
    - Generate button visible on canvas toolbar area (top-right)
    - Clicking opens prompt input panel with count selector (1-4)
    - Panel includes optional image/sketch upload with preview and remove (GEN-02)
    - Submitting triggers optimistic flow: placeholders appear instantly, API call fires (with optional image), placeholders replaced with real image nodes
    - Daily limit check prevents generation when limit reached
    - Error states handled gracefully (placeholder shows error)
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Dev server runs: `npm run dev`
3. Canvas page shows Generate button in top-right corner
4. Full flow: enter prompt -> placeholders appear -> images replace placeholders
5. Image upload: attach image -> thumbnail shows -> generate sends image to API
6. PlaceholderNode shows spinner and prompt text during generation
7. Multiple variations (1-4) appear as separate nodes on canvas
</verification>

<success_criteria>
- User can click Generate on canvas, enter a prompt, and see placeholder nodes appear immediately
- User can optionally attach an image/sketch that is sent to the API for image-to-image generation
- Placeholders show loading spinner with prompt text
- After generation completes, placeholders are replaced with real image nodes
- Image nodes display the generated images on canvas (mock SVG placeholders in dev)
- Count selector allows choosing 1-4 variations
- Daily limit is checked before allowing generation
</success_criteria>

<output>
After completion, create `.planning/phases/05-ai-generation/05-02-SUMMARY.md`
</output>
