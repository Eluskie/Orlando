---
phase: 05-ai-generation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/ai/prompt-builder.ts
  - src/lib/ai/mock.ts
  - src/lib/db/queries/generations.ts
  - src/app/api/generate/route.ts
  - src/types/generation.ts
autonomous: true
user_setup:
  - service: google-ai
    why: "Imagen 4 image generation (mock mode works without key)"
    env_vars:
      - name: GOOGLE_GENERATIVE_AI_API_KEY
        source: "Google AI Studio -> Get API Key (same key used for Gemini chat/extraction)"

must_haves:
  truths:
    - "POST /api/generate with prompt + brandId returns generation with asset URLs"
    - "Brand style keywords are automatically prepended to user prompt"
    - "Mock mode returns 2-4 SVG placeholder variations after simulated delay"
    - "Generation and asset records are created in the database"
    - "Server-side daily rate limit is enforced per brand"
  artifacts:
    - path: "src/lib/ai/prompt-builder.ts"
      provides: "buildStyledPrompt function that combines user prompt with brand style"
      exports: ["buildStyledPrompt"]
    - path: "src/lib/db/queries/generations.ts"
      provides: "Generation CRUD queries with asset relations"
      exports: ["createGeneration", "updateGeneration", "getGenerationHistory", "getGeneration", "getDailyGenerationCount"]
    - path: "src/app/api/generate/route.ts"
      provides: "Generation API endpoint supporting mock and real Imagen 4"
      exports: ["POST", "GET"]
  key_links:
    - from: "src/app/api/generate/route.ts"
      to: "src/lib/ai/prompt-builder.ts"
      via: "buildStyledPrompt import"
      pattern: "buildStyledPrompt"
    - from: "src/app/api/generate/route.ts"
      to: "src/lib/db/queries/generations.ts"
      via: "createGeneration import"
      pattern: "createGeneration|updateGeneration"
    - from: "src/app/api/generate/route.ts"
      to: "src/lib/storage/r2.ts"
      via: "uploadBuffer for generated images"
      pattern: "uploadBuffer"
---

<objective>
Build the generation backend: prompt builder that injects brand style into user prompts, generation DB queries, and upgrade the existing /api/generate route to support mock multi-image generation (2-4 variations) with real Imagen 4 integration (behind feature flag).

Purpose: This is the core generation engine. Without this backend, no UI can trigger image generation. It transforms the existing stub route into a fully functional generation pipeline that retrieves brand style, constructs enhanced prompts, generates multiple variations, stores results to R2, and creates database records.

Output: Working API endpoint that accepts {prompt, brandId, count, aspectRatio} and returns generated asset URLs. Mock mode produces SVG placeholders; real mode calls Imagen 4 via AI SDK.
</objective>

<execution_context>
@C:\Users\gerar\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\gerar\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-ai-generation/05-RESEARCH.md

@src/lib/ai/config.ts
@src/lib/ai/mock.ts
@src/lib/ai/style-extraction.ts
@src/lib/db/schema.ts
@src/lib/db/index.ts
@src/lib/storage/r2.ts
@src/app/api/generate/route.ts
@src/types/brand.ts
@src/types/generation.ts
@src/stores/generation-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create prompt builder and generation DB queries</name>
  <files>
    src/lib/ai/prompt-builder.ts
    src/lib/db/queries/generations.ts
    src/types/generation.ts
  </files>
  <action>
1. Create `src/lib/ai/prompt-builder.ts`:
   - Export `buildStyledPrompt(userPrompt: string, style: ExtractedStyleData | undefined): string`
   - If no style, return userPrompt unchanged
   - Extract key descriptors from the ExtractedStyleData type (from @/types/brand):
     - `style.mood.keywords.join(', ')` for style keywords
     - `style.mood.tone` + `style.colors.primary` for color description
     - `style.visualStyle.complexity` + `style.visualStyle.contrast` for visual description
     - `style.mood.primary` for mood
   - Append style descriptors AFTER the user prompt (harder to override): `"{userPrompt}. Style: {keywords}. Color palette: {tone} tones with primary {primary}. {complexity} design, {contrast} contrast. {mood} mood."`
   - Import ExtractedStyleData from @/types/brand

2. Create `src/lib/db/queries/generations.ts`:
   - Import db from @/lib/db, schema tables from @/lib/db/schema, eq/desc/and/gte/sql from drizzle-orm
   - Export `createGeneration(data: { brandId, prompt, status?, metadata?, conversationId? })` - inserts into generations table, returns the new record
   - Export `updateGeneration(id: string, data: Partial<{status, completedAt, errorMessage}>)` - updates generation record
   - Export `getGenerationHistory(brandId: string, limit = 50)` - uses db.query.generations.findMany with where: eq(generations.brandId, brandId), orderBy: [desc(generations.createdAt)], limit, with: { assets: true }
   - Export `getGeneration(id: string)` - uses db.query.generations.findFirst with where: eq(generations.id, id), with: { assets: true }
   - Export `getDailyGenerationCount(brandId: string): Promise<number>` - counts generations for brandId created today using sql template literal for date comparison: `gte(generations.createdAt, sql\`CURRENT_DATE\`)`

3. Update `src/types/generation.ts`:
   - Add `styledPrompt?: string` to GenerationMetadata interface
   - Add `count?: number` to GenerationMetadata
   - Keep existing fields unchanged
  </action>
  <verify>
    - `npx tsc --noEmit` passes with no type errors
    - prompt-builder.ts exports buildStyledPrompt
    - queries/generations.ts exports all 5 functions
  </verify>
  <done>
    - buildStyledPrompt correctly combines user prompt with brand style data
    - All generation CRUD queries are typed and functional
    - GenerationMetadata includes styledPrompt and count fields
  </done>
</task>

<task type="auto">
  <name>Task 2: Upgrade generate API route with mock multi-image and real Imagen 4</name>
  <files>
    src/app/api/generate/route.ts
    src/lib/ai/mock.ts
  </files>
  <action>
1. Update `src/lib/ai/mock.ts` - add `mockGenerateImages` function:
   - Export `mockGenerateImages(prompt: string, count: number): Promise<{ images: { base64: string }[] }>`
   - Simulate 2-5 second delay (2000 + Math.random() * 3000)
   - Generate `count` SVG placeholders (reuse existing PLACEHOLDER_COLORS array)
   - Each SVG: 512x512, colored background, text showing "Generated #N" and truncated prompt
   - Convert SVG string to base64 with `Buffer.from(svg).toString('base64')`
   - Keep existing mockGenerate and mockChat functions unchanged

2. Rewrite `src/app/api/generate/route.ts` POST handler:
   - Keep existing rate limiting logic (rateLimit function, getClientId helper, RateLimitError handling)
   - Keep existing GET handler unchanged
   - Parse body: `{ prompt, brandId, count = 4, aspectRatio = '1:1' }` with validation
   - Validate count is 1-4 (clamp to range)
   - Validate aspectRatio is one of: '1:1', '3:4', '4:3', '9:16', '16:9'
   - Server-side daily limit check: call `getDailyGenerationCount(brandId)` from queries/generations.ts, compare against AI_CONFIG.generation.dailyLimit, return 429 if exceeded
   - Fetch brand: `db.select().from(brands).where(eq(brands.id, brandId))` - return 404 if not found
   - Build styled prompt: `buildStyledPrompt(prompt, brand.style?.extractedStyle)`
   - Create generation record (status: 'processing') via `createGeneration({ brandId, prompt, metadata: { model, aspectRatio, styledPrompt, count } })`
   - MOCK PATH (isMockMode()):
     - Call `mockGenerateImages(styledPrompt, count)`
     - For each image: create a unique key `brands/${brandId}/generated/${Date.now()}-gen-${generation.id}-${index}.png`, use `uploadBuffer` from r2.ts to store the base64-decoded buffer (BUT in mock mode, skip R2 upload - just use data:image/svg+xml URLs directly)
     - Actually for mock mode: DON'T upload to R2 (may not have credentials). Instead create asset records with data URL directly.
     - Create asset records in DB: `db.insert(assets).values({ brandId, generationId: generation.id, url: dataUrl, name: \`${prompt.slice(0,50)} - Variation ${i+1}\`, type: 'illustration' }).returning()`
     - Update generation status to 'completed' via updateGeneration
     - Return `{ generationId, assets: createdAssets, mode: 'mock' }`
   - REAL PATH (not mock):
     - `import { generateImage } from 'ai'` and `import { google } from '@ai-sdk/google'`
     - Call `generateImage({ model: google.image('imagen-4.0-generate-001'), prompt: styledPrompt, n: count, aspectRatio, providerOptions: { google: { personGeneration: 'allow_adult' } } })`
     - For each result.images: decode base64, upload to R2 via `uploadBuffer(buffer, key, 'image/png')` where key is `brands/${brandId}/generated/${Date.now()}-gen-${generation.id}-${index}.png`
     - Create asset records with R2 URLs
     - Update generation to 'completed'
     - Return `{ generationId, assets: createdAssets }`
   - Wrap everything in try/catch. On error: update generation to 'failed' with errorMessage, return 500
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - With MOCK_AI_MODE=true: `curl -X POST http://localhost:3000/api/generate -H "Content-Type: application/json" -d '{"prompt":"a mountain landscape","brandId":"test-id","count":4}'` returns mock results (will 404 on brand if no brand exists, which is expected - verify the route loads without errors)
    - GET /api/generate still returns rate limit status
  </verify>
  <done>
    - Generate route handles both mock and real Imagen 4 generation
    - Mock mode returns 2-4 SVG placeholder variations with simulated delay
    - Real mode calls AI SDK generateImage, uploads to R2, creates DB records
    - Server-side daily rate limit enforced per brand
    - Generation records track status lifecycle (pending -> processing -> completed/failed)
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. Dev server starts without import errors: `npm run dev`
3. buildStyledPrompt produces enhanced prompts when style data provided
4. Generation route creates database records for generations and assets
5. Mock mode works without any API keys or R2 credentials
</verification>

<success_criteria>
- POST /api/generate accepts prompt + brandId and returns generation with asset data
- Brand style is automatically injected into prompts via buildStyledPrompt
- Mock mode generates 2-4 SVG placeholder variations
- Real mode integrates with Imagen 4 via AI SDK generateImage
- Generation and asset records persist in database
- Server-side daily rate limit prevents exceeding 50 generations per brand per day
</success_criteria>

<output>
After completion, create `.planning/phases/05-ai-generation/05-01-SUMMARY.md`
</output>
