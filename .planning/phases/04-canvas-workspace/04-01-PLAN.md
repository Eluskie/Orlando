---
phase: 04-canvas-workspace
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/canvas/canvas-workspace.tsx
  - src/components/canvas/canvas-image.tsx
  - src/components/canvas/index.ts
  - package.json
  - package-lock.json
autonomous: true

must_haves:
  truths:
    - "Canvas renders as a Stage component taking full available space"
    - "Images from brand assets display on canvas at their stored positions"
    - "Dragging an image updates the canvas store state"
  artifacts:
    - path: "src/components/canvas/canvas-workspace.tsx"
      provides: "Main Stage container with Layer"
      min_lines: 50
    - path: "src/components/canvas/canvas-image.tsx"
      provides: "Image rendering with useImage hook and drag support"
      min_lines: 30
    - path: "src/components/canvas/index.ts"
      provides: "Barrel export"
  key_links:
    - from: "src/components/canvas/canvas-workspace.tsx"
      to: "src/stores/canvas-store.ts"
      via: "useCanvasStore hook"
      pattern: "useCanvasStore"
    - from: "src/components/canvas/canvas-image.tsx"
      to: "src/stores/canvas-store.ts"
      via: "updateObject on dragEnd"
      pattern: "updateObject.*onDragEnd"
---

<objective>
Set up the core Konva canvas infrastructure with Stage container and image rendering.

Purpose: This establishes the foundation for the spatial workspace. Without the Stage and image rendering, no other canvas features can work.

Output: A working canvas component that renders images from the canvas store with basic drag support.
</objective>

<execution_context>
@C:\Users\gerar\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\gerar\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-canvas-workspace/04-RESEARCH.md

@src/stores/canvas-store.ts
@src/stores/brand-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install use-image and create canvas workspace component</name>
  <files>
    package.json
    package-lock.json
    src/components/canvas/canvas-workspace.tsx
    src/components/canvas/index.ts
  </files>
  <action>
1. Install use-image package:
   ```bash
   npm install use-image
   ```

2. Create `src/components/canvas/canvas-workspace.tsx`:
   - Import Stage, Layer from react-konva
   - Import useCanvasStore from @/stores/canvas-store
   - Create CanvasWorkspace component that:
     - Uses a container div with ref for measuring dimensions
     - Renders Stage with width/height from container (use useState + useEffect with ResizeObserver)
     - Sets Stage ref for future imperative operations
     - Stage is draggable (for panning)
     - Stage has onDragEnd that calls setPan(stage.x(), stage.y())
     - Renders single Layer containing objects from store
     - Maps over objects array, rendering CanvasImage for type === "image"
     - Passes object props and isSelected boolean to each CanvasImage
   - Export component

3. Create `src/components/canvas/index.ts`:
   - Barrel export: export { CanvasWorkspace } from "./canvas-workspace"
   - Export { CanvasImage } from "./canvas-image" (for Task 2)

IMPORTANT: Use "use client" directive at top of canvas-workspace.tsx.
IMPORTANT: Stage must set scale from store zoom: `scale={{ x: zoom, y: zoom }}`
IMPORTANT: Stage must set position from store pan: `x={panX} y={panY}`
  </action>
  <verify>
    - `npm run build` passes without errors
    - File exists: src/components/canvas/canvas-workspace.tsx
    - File exists: src/components/canvas/index.ts
  </verify>
  <done>
    - Stage renders with dimensions from container
    - Stage respects zoom and pan from canvas store
    - Layer renders placeholder content
  </done>
</task>

<task type="auto">
  <name>Task 2: Create canvas image component with drag support</name>
  <files>
    src/components/canvas/canvas-image.tsx
    src/components/canvas/canvas-workspace.tsx
  </files>
  <action>
1. Create `src/components/canvas/canvas-image.tsx`:
   - Import Image from react-konva
   - Import useImage from "use-image"
   - Import useCanvasStore from @/stores/canvas-store
   - Import CanvasObject type from canvas-store

2. Create CanvasImage component accepting:
   - object: CanvasObject (must have src for images)
   - isSelected: boolean

3. Implementation:
   - Use useImage hook: `const [image, status] = useImage(object.src!, "anonymous")`
   - Get updateObject from useCanvasStore
   - Return null if status is "loading" or "failed" (simple for now)
   - Return react-konva Image with:
     - id={object.id} (required for Transformer to find it)
     - image={image}
     - x={object.x}
     - y={object.y}
     - width={object.width}
     - height={object.height}
     - rotation={object.rotation}
     - scaleX={object.scaleX}
     - scaleY={object.scaleY}
     - opacity={object.opacity}
     - visible={object.visible}
     - draggable={!object.locked}
     - onDragEnd={(e) => updateObject(object.id, { x: e.target.x(), y: e.target.y() })}

4. Update canvas-workspace.tsx:
   - Import CanvasImage
   - In the Layer, map objects and render CanvasImage for each where type === "image"

5. Update index.ts to export CanvasImage

IMPORTANT: Add "use client" directive.
IMPORTANT: The id prop on Image is CRITICAL - without it, Transformer cannot select the shape in Plan 02.
  </action>
  <verify>
    - `npm run build` passes
    - File exists: src/components/canvas/canvas-image.tsx
    - Grep for "useImage" in canvas-image.tsx returns a match
    - Grep for "onDragEnd" in canvas-image.tsx returns a match
  </verify>
  <done>
    - CanvasImage loads images via useImage hook
    - Dragging image updates store position via onDragEnd
    - Images render at correct position/size/rotation from store
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npm run build` passes
2. Files exist in src/components/canvas/
3. Canvas store actions (updateObject) are wired to drag events
4. TypeScript has no errors related to canvas components
</verification>

<success_criteria>
- CanvasWorkspace component renders a Konva Stage with responsive dimensions
- CanvasImage component loads and displays images with drag-to-move
- Store state drives rendering (objects array -> rendered images)
- Drag updates flow back to store (onDragEnd -> updateObject)
</success_criteria>

<output>
After completion, create `.planning/phases/04-canvas-workspace/04-01-SUMMARY.md`
</output>
