---
phase: 04-canvas-workspace
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/components/canvas/canvas-toolbar.tsx
  - src/components/canvas/canvas-workspace.tsx
  - src/components/canvas/index.ts
autonomous: true

must_haves:
  truths:
    - "User sees a toolbar with zoom controls and undo/redo buttons"
    - "Undo/redo buttons work and are disabled when history is empty"
    - "Zoom percentage is displayed in toolbar"
    - "Fit-to-view button resets zoom and pan"
  artifacts:
    - path: "src/components/canvas/canvas-toolbar.tsx"
      provides: "Toolbar with zoom and undo/redo controls"
      min_lines: 40
  key_links:
    - from: "src/components/canvas/canvas-toolbar.tsx"
      to: "src/stores/canvas-store.ts"
      via: "useCanvasStore and temporal.getState()"
      pattern: "useCanvasStore\\.temporal\\.getState"
---

<objective>
Create the canvas toolbar with zoom controls and undo/redo functionality.

Purpose: Users need visual controls for canvas manipulation. The toolbar provides discoverable UI for zoom, undo/redo, and view reset - essential for any spatial workspace.

Output: A floating toolbar component integrated into the canvas workspace.
</objective>

<execution_context>
@C:\Users\gerar\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\gerar\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-canvas-workspace/04-RESEARCH.md

@src/stores/canvas-store.ts
@src/components/canvas/canvas-workspace.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create canvas toolbar component</name>
  <files>
    src/components/canvas/canvas-toolbar.tsx
    src/components/canvas/index.ts
  </files>
  <action>
1. Create `src/components/canvas/canvas-toolbar.tsx`:
   - Add "use client" directive
   - Import icons from lucide-react: Undo2, Redo2, ZoomIn, ZoomOut, Maximize2
   - Import useCanvasStore from @/stores/canvas-store
   - Import Button from @/components/ui/button (if exists) OR use native button with Tailwind

2. Create CanvasToolbar component:
   - Get zoom, setZoom, resetView from useCanvasStore
   - Get undo, redo, pastStates, futureStates from useCanvasStore.temporal.getState()
   - Note: For reactivity with temporal state, use useSyncExternalStore or subscribe pattern:
     ```typescript
     const { undo, redo } = useCanvasStore.temporal.getState();
     const [canUndo, setCanUndo] = useState(false);
     const [canRedo, setCanRedo] = useState(false);

     useEffect(() => {
       const unsubscribe = useCanvasStore.temporal.subscribe((state) => {
         setCanUndo(state.pastStates.length > 0);
         setCanRedo(state.futureStates.length > 0);
       });
       return unsubscribe;
     }, []);
     ```

3. Render toolbar UI:
   - Container: absolute positioned, top-4 left-4
   - Tailwind: "absolute top-4 left-4 flex items-center gap-1 bg-white rounded-lg shadow-md border border-gray-200 p-1"
   - Undo button: onClick={() => undo()}, disabled={!canUndo}
   - Redo button: onClick={() => redo()}, disabled={!canRedo}
   - Divider: <div className="w-px h-6 bg-gray-200" />
   - Zoom out: onClick={() => setZoom(zoom / 1.2)}
   - Zoom in: onClick={() => setZoom(zoom * 1.2)}
   - Reset view: onClick={resetView}
   - Zoom display: <span className="text-sm text-gray-500 px-2 min-w-[50px] text-center">{Math.round(zoom * 100)}%</span>

4. Button styling (consistent with project design):
   - Base: "p-2 rounded hover:bg-gray-100 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
   - Icon size: "w-4 h-4"

5. Update index.ts to export CanvasToolbar

IMPORTANT: The temporal state requires subscription for reactivity - pastStates/futureStates don't trigger re-renders automatically.
  </action>
  <verify>
    - `npm run build` passes
    - File exists: src/components/canvas/canvas-toolbar.tsx
    - Grep for "temporal.getState" in canvas-toolbar.tsx returns a match
    - Grep for "Undo2" in canvas-toolbar.tsx returns a match
  </verify>
  <done>
    - Toolbar renders with all buttons (undo, redo, zoom in, zoom out, fit, percentage)
    - Undo/redo buttons are disabled when no history
    - Zoom percentage reflects current zoom level
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate toolbar into workspace</name>
  <files>
    src/components/canvas/canvas-workspace.tsx
  </files>
  <action>
1. Update canvas-workspace.tsx:
   - Import CanvasToolbar from ./canvas-toolbar
   - Wrap the entire workspace in a relative-positioned container
   - Add CanvasToolbar as a sibling to Stage (outside Stage, inside container)

2. Structure:
   ```tsx
   return (
     <div ref={containerRef} className="relative w-full h-full">
       <Stage
         width={dimensions.width}
         height={dimensions.height}
         // ... other props
       >
         <Layer ref={layerRef}>
           {/* objects */}
           <CanvasTransformer selectedIds={selectedIds} layerRef={layerRef} />
         </Layer>
       </Stage>
       <CanvasToolbar />
     </div>
   );
   ```

3. Ensure the container div has:
   - ref={containerRef} for dimension measurement
   - className includes "relative" for toolbar positioning
   - Full dimensions: "w-full h-full" or explicit sizing

IMPORTANT: Toolbar must be OUTSIDE Stage (it's HTML, not canvas) but INSIDE the relative container.
  </action>
  <verify>
    - `npm run build` passes
    - Grep for "CanvasToolbar" in canvas-workspace.tsx returns a match
    - Grep for "relative" in canvas-workspace.tsx returns a match
  </verify>
  <done>
    - Toolbar appears in top-left of canvas workspace
    - All toolbar buttons are functional
    - Toolbar floats above canvas (not affected by zoom/pan)
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npm run build` passes
2. Toolbar renders with all controls
3. Undo/redo work with proper disable states
4. Zoom controls update canvas zoom
5. Fit-to-view resets zoom and pan
</verification>

<success_criteria>
- Toolbar is visible and positioned correctly
- Undo button disabled when no past states
- Redo button disabled when no future states
- Zoom in/out buttons change zoom level
- Zoom percentage displays accurately
- Fit button resets to 100% zoom at 0,0 position
</success_criteria>

<output>
After completion, create `.planning/phases/04-canvas-workspace/04-03-SUMMARY.md`
</output>
