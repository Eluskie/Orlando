---
phase: 06-integration-export
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/chat/chat-sidebar.tsx
  - src/app/(chat)/[brandId]/canvas/page.tsx
  - src/lib/ai/chat.ts
  - src/components/canvas/canvas-workspace.tsx
autonomous: true

must_haves:
  truths:
    - "Floating chat sidebar appears in canvas view (right side or toggleable)"
    - "Chat messages persist when navigating between chat and canvas views"
    - "User can send messages from chat sidebar while on canvas"
    - "Chat generation detection triggers canvas node creation"
    - "detectGenerationIntent wired into chat input submission"
    - "triggerGenerationFromChat adds results to canvas automatically"
    - "Sidebar is collapsible/toggleable to maximize canvas space"
  artifacts:
    - path: "src/components/chat/chat-sidebar.tsx"
      provides: "Floating chat component for canvas view with toggle"
      exports: ["ChatSidebar"]
    - path: "src/app/(chat)/[brandId]/canvas/page.tsx"
      provides: "Canvas page with integrated chat sidebar"
    - path: "src/lib/ai/chat.ts"
      provides: "Generation detection already exists, verified in this plan"
  key_links:
    - from: "src/components/chat/chat-sidebar.tsx"
      to: "src/lib/ai/chat.ts"
      via: "detectGenerationIntent on message submit"
      pattern: "detectGenerationIntent"
    - from: "src/components/chat/chat-sidebar.tsx"
      to: "src/lib/ai/chat.ts"
      via: "triggerGenerationFromChat when intent detected"
      pattern: "triggerGenerationFromChat"
    - from: "src/components/chat/chat-sidebar.tsx"
      to: "src/stores/canvas-store.ts"
      via: "addNode for generation results"
      pattern: "addNode"
---

<objective>
Build floating chat sidebar for canvas view and wire Phase 5 generation utilities. Users can chat while working on canvas, and saying "generate an image of X" automatically triggers generation and adds results to canvas.

Purpose: This completes CHAT-06 (floating chat in canvas view) and wires the Phase 5 generation detection utilities (detectGenerationIntent, triggerGenerationFromChat) into the UI. The sidebar persists conversation context while users work spatially on the canvas.

Output: Working chat sidebar component with generation detection, integrated into canvas page, toggleable to maximize space.
</objective>

<execution_context>
@C:\Users\gerar\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\gerar\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-ai-generation/05-03-SUMMARY.md

@src/components/chat/chat-layout.tsx
@src/components/chat/chat-messages.tsx
@src/components/chat/chat-input.tsx
@src/lib/ai/chat.ts
@src/stores/canvas-store.ts
@src/stores/brand-store.ts
@src/stores/chat-store.ts
@src/app/(chat)/[brandId]/canvas/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ChatSidebar component with generation detection</name>
  <files>
    src/components/chat/chat-sidebar.tsx
  </files>
  <action>
1. Create `src/components/chat/chat-sidebar.tsx`:
   - 'use client' directive
   - Import: useState, useChat from ai/react, ChatMessages, ChatInput, MessageSquare, X, ChevronRight from lucide-react
   - Import: detectGenerationIntent, triggerGenerationFromChat from @/lib/ai/chat
   - Import: useBrandStore, useCanvasStore from stores
   - Export `ChatSidebar` component
   - Props: `brandId: string`
   - State: `isOpen` (boolean, default true - expandedcollapsed), `isGenerating` (boolean)
   - Use `useChat` hook with api: `/api/chat`, body: { brandId }
   - Get `addNode` from useCanvasStore
   - Get `activeBrand` from useBrandStore
   - **Override handleSubmit from useChat:**
     - On form submit, first check detectGenerationIntent(input)
     - If isGeneration=true and prompt exists:
       - Set isGenerating = true
       - Call triggerGenerationFromChat(prompt, brandId)
       - On success: Loop through assets, create image nodes with type: 'image', position distributed (x: 100 + i * 220, y: 500), data: { src: asset.url, width: 200, height: 200, opacity: 1, locked: false, label: asset.name }
       - Call addNode for each
       - Clear input, set isGenerating = false
       - Do NOT send to chat API (handled programmatically)
     - Else (not generation): call original useChat handleSubmit (send to chat API normally)
   - Render structure:
     - When collapsed (!isOpen): Fixed button on right edge (right-4 top-4 z-30), MessageSquare icon + "Chat", bg-white shadow-lg rounded-l-lg px-3 py-2, onClick toggle
     - When expanded (isOpen): Fixed panel on right side:
       - Div: fixed right-0 top-0 h-full w-96 bg-white shadow-xl border-l z-20 flex flex-col
       - Header: flex justify-between items-center p-4 border-b, "Chat" title, collapse button (ChevronRight icon)
       - Body: flex-1 overflow-hidden flex flex-col
         - ChatMessages (messages from useChat, flex-1 overflow-y-auto)
         - ChatInput (input, handleInputChange, handleSubmit (override), isLoading || isGenerating, brandId)
   - During generation: show "Generating and adding to canvas..." indicator in chat
   - Memoize message rendering for performance

2. Export from `src/components/chat/index.ts` if needed, or import directly in canvas page

  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - ChatSidebar renders with toggle button when collapsed
    - Panel slides in/out smoothly
    - detectGenerationIntent called on input
    - Normal chat messages work (non-generation)
  </verify>
  <done>
    - ChatSidebar component with collapsible panel
    - Generation detection wired to detectGenerationIntent
    - triggerGenerationFromChat integration complete
    - Canvas nodes created from generation results
    - useChat integration for normal chat messages
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate ChatSidebar into canvas page</name>
  <files>
    src/app/(chat)/[brandId]/canvas/page.tsx
  </files>
  <action>
1. Update canvas page:
   - Import ChatSidebar from @/components/chat/chat-sidebar
   - Keep existing ReactFlowProvider wrapper and CanvasWorkspace
   - Add ChatSidebar as sibling to CanvasWorkspace (outside ReactFlowProvider):
     ```tsx
     <div className="flex h-screen w-full flex-col bg-gray-100">
       <ReactFlowProvider>
         <CanvasWorkspace />
       </ReactFlowProvider>
       <ChatSidebar brandId={brandId} />
     </div>
     ```
   - ChatSidebar renders on top with z-index layering
   - No changes to asset loading logic
  </action>
  <verify>
    - Canvas page loads without errors
    - Chat sidebar appears on right side
    - Sidebar can be toggled without affecting canvas
    - Canvas interactions (zoom, pan, drag) still work
  </verify>
  <done>
    - ChatSidebar integrated into canvas view
    - Z-index layering correct (sidebar above canvas controls)
    - Both chat and canvas functional simultaneously
    - Navigation between chat and canvas preserves state
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Dev server runs: `npm run dev`
3. Navigate to canvas view: Chat sidebar visible on right
4. Test generation: Type "generate an image of a sunset" in sidebar
5. Verify: Placeholder nodes appear, then replaced with generated images
6. Test normal chat: Type "hello" - normal chat response appears
7. Test toggle: Collapse/expand sidebar - canvas space adjusts
8. Test persistence: Navigate chat -> canvas -> chat - messages persist
</verification>

<success_criteria>
- Floating chat sidebar appears in canvas view (right side, toggleable)
- Chat messages persist when navigating between chat and canvas views
- User can send messages from sidebar while on canvas
- "generate an image of X" triggers detectGenerationIntent
- triggerGenerationFromChat adds results to canvas automatically
- Normal chat messages still work through /api/chat
- Sidebar collapse maximizes canvas space
- Phase 5 utilities fully wired and functional
</success_criteria>

<output>
After completion, create `.planning/phases/06-integration-export/06-01-SUMMARY.md`
</output>
