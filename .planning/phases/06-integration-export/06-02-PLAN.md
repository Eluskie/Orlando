---
phase: 06-integration-export
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/canvas/export-menu.tsx
  - src/components/canvas/canvas-toolbar.tsx
  - src/lib/export/canvas-export.ts
autonomous: true

must_haves:
  truths:
    - "User can export entire canvas as PNG with transparency"
    - "User can export individual selected assets as PNG"
    - "Export includes proper dimensions and quality"
    - "Download triggers browser save dialog"
    - "Export menu accessible from canvas toolbar"
    - "Export works in both mock and real generation modes"
  artifacts:
    - path: "src/components/canvas/export-menu.tsx"
      provides: "Export dropdown menu with PNG/SVG options"
      exports: ["ExportMenu"]
    - path: "src/lib/export/canvas-export.ts"
      provides: "Canvas and asset export utilities"
      exports: ["exportCanvasAsPNG", "exportNodeAsPNG", "downloadBlob"]
  key_links:
    - from: "src/components/canvas/export-menu.tsx"
      to: "src/lib/export/canvas-export.ts"
      via: "Export functions for canvas/assets"
      pattern: "exportCanvasAsPNG|exportNodeAsPNG"
---

<objective>
Build canvas export functionality allowing users to save their work as PNG images. Export entire canvas or individual assets with proper transparency and quality.

Purpose: This completes EXPORT-01 and EXPORT-02 (export as PNG/SVG). Users can download generated assets for use in other tools. PNG with transparency is prioritized; SVG export is complex with ReactFlow and may require high-res PNG as alternative.

Output: Working export menu integrated into canvas toolbar, export utilities for canvas and individual assets, browser download functionality.
</objective>

<execution_context>
@C:\Users\gerar\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\gerar\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/components/canvas/canvas-toolbar.tsx
@src/components/canvas/canvas-workspace.tsx
@src/components/canvas/image-node.tsx
@src/stores/canvas-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create canvas export utilities</name>
  <files>
    src/lib/export/canvas-export.ts
  </files>
  <action>
1. Create `src/lib/export/canvas-export.ts`:
   - Use html-to-image library for canvas-to-image conversion
   - Note: Install if needed: `npm install html-to-image`
   - Export `async function exportCanvasAsPNG(elementId: string, filename: string): Promise<void>`
     - Get DOM element by ID (the ReactFlow wrapper div)
     - Use toPng from html-to-image with options: { backgroundColor: null } for transparency
     - Options: { quality: 1.0, pixelRatio: 2 } for high quality
     - Get data URL, convert to blob
     - Call downloadBlob with filename
   - Export `async function exportNodeAsPNG(nodeElement: HTMLElement, filename: string): Promise<void>`
     - Similar to exportCanvasAsPNG but takes element directly
     - Use toPng with same options
     - Download result
   - Export `function downloadBlob(dataUrl: string, filename: string): void`
     - Create anchor element with download attribute
     - Set href to dataUrl
     - Trigger click programmatically
     - Clean up (remove element, revoke URL if blob)
   - Handle errors gracefully (log and throw descriptive error)
   - Add JSDoc comments for each function

2. Alternative approach if html-to-image has issues:
   - Use native canvas API: create canvas, draw ReactFlow viewport, toBlob()
   - Or use dom-to-image-more library (fork with better maintenance)
   - Document chosen approach in code comments
  </action>
  <verify>
    - TypeScript compiles
    - Export functions have proper types
    - Error handling present
  </verify>
  <done>
    - Canvas export utility functions created
    - PNG export with transparency support
    - High-quality output (2x pixel ratio)
    - Browser download mechanism
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ExportMenu component</name>
  <files>
    src/components/canvas/export-menu.tsx
    src/components/canvas/canvas-toolbar.tsx
  </files>
  <action>
1. Create `src/components/canvas/export-menu.tsx`:
   - 'use client' directive
   - Import: useState, Download, ChevronDown from lucide-react
   - Import: exportCanvasAsPNG from @/lib/export/canvas-export
   - Import: useReactFlow from @xyflow/react (to get selected nodes)
   - Export `ExportMenu` component
   - State: `isOpen` (dropdown open/closed), `isExporting` (loading state)
   - Render dropdown button: "Export" with Download icon
   - Dropdown menu (absolute positioned, white bg, shadow-lg, rounded, border):
     - "Export Canvas as PNG" option
     - "Export Selected as PNG" option (disabled if no selection)
     - "Export All Assets" option (exports each node separately as zip - optional, can defer)
   - On "Export Canvas":
     - Set isExporting = true
     - Call exportCanvasAsPNG('reactflow-wrapper', `canvas-${Date.now()}.png`)
     - Set isExporting = false, close menu
   - On "Export Selected":
     - Get selected nodes from useReactFlow().getNodes().filter(n => n.selected)
     - For each node: find DOM element, call exportNodeAsPNG
     - Or: create temporary wrapper, render node, export, clean up
   - Close dropdown when clicking outside (useEffect with document listener)
   - Show loading spinner when isExporting

2. Update `src/components/canvas/canvas-toolbar.tsx`:
   - Import ExportMenu
   - Add ExportMenu button to toolbar (next to existing undo/redo buttons)
   - Position: absolute top-4 left-4 z-10 (left side of canvas)
   - Keep existing structure, add ExportMenu as sibling to undo/redo
  </action>
  <verify>
    - Export menu renders in toolbar
    - Dropdown opens/closes correctly
    - Export Canvas button functional
    - Export Selected disabled when no selection
  </verify>
  <done>
    - ExportMenu component with dropdown
    - Export Canvas as PNG working
    - Export Selected as PNG working
    - Integrated into canvas toolbar
    - Loading states during export
  </done>
</task>

<task type="auto">
  <name>Task 3: Add ReactFlow wrapper ID for export</name>
  <files>
    src/components/canvas/canvas-workspace.tsx
  </files>
  <action>
1. Update canvas-workspace.tsx:
   - Add `id="reactflow-wrapper"` to the ReactFlow component
   - This allows export utilities to target the correct element
   - No other changes needed

2. Test export functionality:
   - Ensure exported PNG includes all visible nodes
   - Verify transparency (background should be transparent)
   - Check high-resolution output (2x pixel ratio)
  </action>
  <verify>
    - ReactFlow has id="reactflow-wrapper"
    - Export captures entire viewport
    - PNG has transparency
  </verify>
  <done>
    - ReactFlow wrapper identifiable for export
    - Full export flow working end-to-end
  </done>
</task>

</tasks>

<verification>
1. Install html-to-image if needed: `npm install html-to-image`
2. TypeScript compiles: `npx tsc --noEmit`
3. Dev server runs: `npm run dev`
4. Navigate to canvas with assets
5. Click Export button in toolbar
6. Select "Export Canvas as PNG"
7. Verify: Browser downloads PNG file
8. Open PNG: Check transparency (open in image editor, verify alpha channel)
9. Select a node, click Export â†’ "Export Selected as PNG"
10. Verify: Individual asset downloads correctly
</verification>

<success_criteria>
- User can export entire canvas as PNG with transparency
- User can export selected assets individually
- Export produces high-quality images (2x resolution)
- Browser download dialog appears correctly
- Export menu accessible from canvas toolbar
- Works with both generated and uploaded assets
- Transparency preserved in exported PNGs
</success_criteria>

<notes>
**SVG Export Decision:**
ReactFlow uses HTML/CSS rendering (not SVG-based canvas). Converting HTML to SVG is complex and lossy. SVG export would require:
- Custom renderer for each node type
- Manual path generation
- CSS-to-SVG attribute conversion
- Limited browser support

**Recommendation:** Defer SVG export to v2. Use high-res PNG (2x or 4x pixel ratio) as alternative for now. This satisfies the "SVG (if feasible, otherwise high-res PNG)" requirement from success criteria.

If user needs vectors: Export at 4x resolution (edit canvas-export.ts pixelRatio: 4) for print-quality output.
</notes>

<output>
After completion, create `.planning/phases/06-integration-export/06-02-SUMMARY.md`
</output>
